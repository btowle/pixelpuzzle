<html>
<head>
<title>PixelPuzzle</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
 <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
<script>
var Util = {
  idToValue: function(id){
    var strings = id.split("-");
    var ret = [parseInt(strings[1]), parseInt(strings[0])];
    return ret;
  },
  arrayToNum: function(arr){
    var num = 0;
    for(var i=0; i < arr.length; i++){
      num = num | (arr[i] << arr.length-i-1);
    }
    return num;
  },
  numToArray: function(num, size){
    var arr = [];
    if(num < 0){
      num = 0;
    }
    for(var i=0; i < size; i++){
      arr[arr.length] = num & 1;
      num = num >>> 1;
    }
    return arr.reverse();
  },
  arrayToString: function(arr){
    var str = arr.length+":";
    for(var i=0; i < arr.length; i++){
      str += ":" + Util.arrayToNum(arr[i]);
    }
    return str;
  },
  stringToArray: function(str){
    var tokens = str.split('::');
    var size = parseInt(tokens[0]);
    if(size > 9 || size < 1){
      size = 1;
      tokens[1] = '1';
    }
    tokens = tokens[1].split(':');
    if(tokens.length != size){
      size = 1;
      tokens[0] = '1';
    }
    var arr = [];
    for(var i = 0; i < size; i++){
      arr[i] = Util.numToArray(parseInt(tokens[i]), size);
    }
    return arr;
  }
}
var Game = {
  guessArray: [],
  answerArray: [],
  clues: {
    columns: [],
    rows: []
  },
  setGuess: function(idstr, val){
    var id = Util.idToValue(idstr);
    var set = 0;
    if(val){ set = 1; }
    Game.guessArray[id[0]][id[1]] = set;
    Game.checkPuzzle();
  },
  checkPuzzle: function(){
    var valid = true;
    var size = Game.answerArray.length;
    for(var i=0; i < size; i++){
      for(var j=0; j < size; j++){
        var bothTrue = (Game.answerArray[i][j] && Game.guessArray[i][j]);
        var bothFalse = (!Game.answerArray[i][j] && !Game.guessArray[i][j]);
        if(!(bothTrue || bothFalse)){
          valid = false;
        }
      }
    }
    if(valid){
      alert('you win!');
    }
  },
  initGuessArray: function(){
    var size = Game.answerArray.length;
    for(var i = 0; i < size; i++){
      Game.guessArray[i] = new Array();
    }
  },
  initClues: function(){
    var size = Game.answerArray.length;
    var prevRow;
    var prevCol;
    for(var i=0; i < size; i++){
      var prevRow = 0;
      var prevCol = 0;
      Game.clues.rows[i] = new Array();
      Game.clues.columns[i] = new Array();
      for(var j=0; j < size; j++){
        if(Game.answerArray[i][j]){
          if(prevRow){
            Game.clues.rows[i][Game.clues.rows[i].length-1]++;
          }else{
            Game.clues.rows[i][Game.clues.rows[i].length] = 1;
          }
          prevRow = 1;
        }else{
          prevRow = 0;
        }
        if(Game.answerArray[j][i]){
          if(prevCol){
            Game.clues.columns[i][Game.clues.columns[i].length-1]++;
          }else{
            Game.clues.columns[i][Game.clues.columns[i].length] = 1;
          }
          prevCol = 1;
        }else{
          prevCol = 0;
        }
      }
    }

  },
  makeClueString: function(){
    //make clueString
    var clueString = '<div class="number-row">';
    for(var i=0; i < Game.clues.columns.length; i++){
      clueString += '<div class="column-numbers"><div class="column-numbers-group">';
      for(var j=0; j < Game.clues.columns[i].length; j++){
        clueString += '<div>'+Game.clues.columns[i][j]+'</div>';
      }
      clueString += '</div></div>';
    }
    clueString += '</div><div class="number-column">';
    for(var i = 0; i < Game.size; i++){
      clueString +='<div class="row-numbers">';
      for(var j = Game.clues.rows[i].length-1; j >= 0; j--){
        clueString += '<div>'+Game.clues.rows[i][j]+'</div>';
      }
      clueString += '</div>';
    }
    clueString += '</div></div>';
    return clueString;
  },
  makeGridString: function(){
    //make gridString
    var size = Game.answerArray.length;
    Game.size = size;
    var gridString = '<div id="grid">';
    for(var i = 0; i < size; i++){
      gridString += '<div class="grid-row">';
      for(var j = 0; j < size; j++){
        gridString += '<div id="'+j+'-'+i+'" class="grid-cell">X</div>'
      }
      gridString += '</div>';
    }
    gridString += '</div>';
    return gridString;
  },
  initJQuery: function(){
    $(".column-numbers-group > div, .row-numbers > div").click(function(){
      if($(this).hasClass('line-through')){
        $(this).removeClass('line-through');
      }else{
        $(this).addClass('line-through');
      }
    });
    $(".grid-cell").click(function(){
      if($(this).hasClass('yes')){
        $(this).removeClass('yes');
        $(this).addClass('no');
        Game.setGuess(this.id, false);
      }else if($(this).hasClass('no')){
        $(this).removeClass('no');
      }else{
        $(this).addClass('yes');
        Game.setGuess(this.id, true);
      }
    });
    $("#number-in").submit(function(){
      var arrout = Util.numToArray(parseInt($("#num").val()));
      var numout = Util.arrayToNum(arrout);
      $("#array-out").html( arrout );
      $("#number-out").html( numout );
      return false;
    });
  },
  init: function(initstr){
    if(!initstr){
      initstr = '5::17:10:4:10:17';
    }
    Game.answerArray = Util.stringToArray(initstr);
    var size = Game.answerArray.length;
    Game.initGuessArray();
    Game.initClues();
    var htmlString = '';
    htmlString += Game.makeClueString();
    htmlString += Game.makeGridString();

    $('body').append(htmlString);
    Game.initJQuery();
  }
}
$(function(){
  Game.init();
});
</script>
<style>
body{
  padding: 0;
  margin: 0;
}
#grid{
  width: 500px;
  height: 500px;
  position: absolute;
  left: 100px;
  top: 100px;
  -webkit-user-select:none;
}
.grid-row{
  width: 100%;
  height: 50px;
  clear: both;
  position: relative;
}
.grid-cell{
  width: 50px;
  height: 50px;
  float: left;
  text-align: center;
  position: relative;
  border: 1px solid #333;
  color: #FFF;
  cursor:default;
}
.number-row{
  width: 100%;
  height: 100px;
  position: absolute;
  top: 0px;
  left: 122px;
}
.number-column{
  position: absolute;
  top: 122;
  left: 0;
}
.row-numbers{
  -webkit-user-select:none;
  cursor:default;
  width: 100px;
  height: 50px;
}
.row-numbers > div{
  float:right;
  padding: 4px;
}
.column-numbers-group{
  text-align: center;
  position: absolute;
  bottom: 0;
}
.column-numbers{
  width: 50px;
  height: 100%;
  float: left;
  -webkit-user-select:none;
  cursor:default;
}
.line-through{
  text-decoration: line-through;
}
.yes{
  background-color: #000;
  color: #000;
}
.no{
  background-color: #FCC;
  color: #FCC;
}
.column-break{
  clear: both;
}

</style>
</head>
<body>
</body>
</html>
